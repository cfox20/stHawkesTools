---
title: "Getting Started with stHawkesTools"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with stHawkesTools}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The `stHawkesTools` package provides utilities for simulating, fitting, and
summarising spatio-temporal Hawkes processes.  This vignette walks through a
complete analysis workflow:

1. define the spatial domain and model parameters;
2. simulate a Hawkes process;
3. estimate the model with maximum likelihood;
4. quantify uncertainty via the cluster bootstrap; and
5. visualise the resulting point pattern.

Throughout we focus on the default isotropic Gaussian spatial kernel and the
exponential temporal kernel supplied with the package.

## Installation

The development version of `stHawkesTools` is hosted on GitHub.  Install it
with `remotes::install_github()` (or the equivalent `devtools::install_github()`)
before working through this vignette.

```{r install, eval = FALSE}
# install.packages("remotes")
# remotes::install_github("cfox20/stHawkesTools")
```

## Setup

```{r setup}
library("stHawkesTools")
library("dplyr")
library("tibble")
library("tidyr")
library("ggplot2")
theme_set(theme_minimal())
theme_update(panel.grid.minor = element_blank(), 
  plot.title = element_text(hjust = 0.5))

set.seed(123)
```

## Defining a spatial region

The simulation and estimation routines operate on `sf` polygons that describe
where events may occur.  The helper `create_rectangular_sf()` builds a simple
rectangular window by supplying the minimum and maximum `x` and `y`
coordinates.

```{r region}
x_centers <- seq(0.5, 9.5, length.out = 10)
y_centers <- seq(0.5, 9.5, length.out = 10)

center_covariate <- exp(-(((rep(x_centers, times = 10) - 5)^2 +
                            (rep(y_centers, each = 10) - 5)^2) / 4))
center_covariate <- (center_covariate - min(center_covariate)) /
  (max(center_covariate) - min(center_covariate))

spatial_region <- create_rectangular_sf(
  xmin = 0, xmax = 10,
  ymin = 0, ymax = 10,
  covariates = data.frame(center = center_covariate),
  n_grid = c(10, 10)
)

spatial_region
```

The object prints as an `sf` data frame.  The `center` column contains a
covariate that peaks in the middle of the region.  We can visualise both the
observation window and this covariate surface using base `sf` plotting tools.

```{r region-plot, fig.width=10, fig.height=5}
spatial_region |> 
  ggplot() +
    geom_sf(aes(fill = center))
```

## Specifying model parameters

A Hawkes model combines a log-linear background rate (for exogenous events) with
self-excitation governed by the triggering kernel.  Parameters are supplied as a
named list with entries for the background rate, triggering rate, and the
parameters of the spatial and temporal kernels.  The background rate list can
include regression coefficients if spatial covariates are present; here we use
an intercept and the coefficient for the `center` covariate constructed above.

```{r parameters}
true_params <- list(
  background_rate = list(intercept = -6, center = 5),
  triggering_rate = 0.5,
  spatial   = list(mean = 0, sd = 0.45),
  temporal  = list(rate = 1.5)
)
true_params
```

The intercept corresponds to a baseline log-intensity of roughly
\(\exp(-6.5) \approx 0.0015\) events per unit area per unit time.  Adding three
times the `center` covariate increases this intensity towards the middle of the
region, while the triggering rate controls how many offspring each event tends
to generate.

## Simulating a spatio-temporal Hawkes process

With the region and parameter list defined we can simulate a point pattern using
`rHawkes()`.  Here we generate events over the time window \([0, 40]\).

```{r simulate}
hawkes <- rHawkes(
  params = true_params,
  time_window = c(0, 40),
  spatial_region = spatial_region,
  covariate_columns = "center",
  spatial_burnin = 1
)

hawkes
```

The returned object is an `sf` tibble containing the event coordinates (`x`,
`y`), occurrence times (`t`), the `center` covariate at each location, and a
geometry column.

```{r head-events}
head(sf::st_drop_geometry(hawkes))
```

## Visualising simulated events

The convenience function `plot_hawkes()` produces `ggplot2` graphics coloured by
either event time or whether the event is a background (immigrant) or triggered
(descendant) event.  For simulated data the latter uses the known parentage
structure from the generating process.

```{r plot-time, fig.width=5.5, fig.height=5.5}
plot_hawkes(hawkes, color = "time")
```

```{r plot-background, fig.width=5.5, fig.height=5.5}
plot_hawkes(hawkes, color = "background")
```


## Maximum likelihood estimation

Parameter estimation uses the expectationâ€“maximisation (EM) algorithm implemented
in `hawkes_mle()`.  The function requires initial values in the same format as
`rHawkes()`.  Providing reasonable starting values helps the algorithm converge
quickly; here we perturb the true parameters slightly.

```{r estimation}
initial_values <- list(
  background_rate = list(intercept = -6, center = 2.5),
  triggering_rate = 0.5,
  spatial   = list(mean = 0, sd = 0.5),
  temporal  = list(rate = 1.8)
)

est <- hawkes_mle(
  hawkes,
  inits = initial_values,
  boundary = 0.5,
  max_iters = 200
)

est
```

The returned `hawkes_fit` object stores the parameter estimates, fitted residuals
and the original `hawkes` data.  The standard `summary()` method reports the
point estimates alongside Wald standard errors and confidence intervals derived
from the observed information matrix.

```{r estimation-summary}
summary(est)
```

## Visualising the fitted intensity surface

The fitted model lets us interrogate the conditional intensity across space and
time.  Evaluating the spatial intensity at the end of the observation window
highlights how the covariate concentrates activity in the middle of the region,
while the temporal profile at the centre of the window shows how excitation
builds as events occur.

```{r fitted-intensity}
intensity_views <- plot_intensity(
  hawkes,
  est,
  stepsize = 0.1,
  time = 40,
  coordinates = c(5, 5)
)

intensity_views$spatial
intensity_views$temporal
```


## Uncertainty assessment with the cluster bootstrap

Spatial-temporal clustering can produce highly skewed sampling distributions for
MLEs.  The cluster bootstrap repeatedly resamples whole estimated clusters and
re-estimates the model, capturing this dependence structure.  The
`cluster_bootstrap()` function requires the fitted `hawkes` object, the
corresponding `hawkes_fit`, and the number of bootstrap replications `B`.

```{r bootstrap}
boot_results <- cluster_bootstrap(
  hawkes = hawkes,
  est = est,
  B = 3,
  alpha = 0.05,
  boundary = 0.5,
  max_iters = 200
)

boot_results
```

Each row contains the bootstrap median, percentile-based interval, estimated
standard deviation, and the proportion of bootstrap fits that failed to converge
(if any).  Larger `B` yields smoother estimates at the cost of additional
computation; parallel processing is available by setting `parallel = TRUE` after
configuring a `future` plan.

## Next steps

This introductory example highlights the core workflow supported by
`stHawkesTools`.  Further functionality includes subsampling utilities, residual
analysis, and tools for working with covariate surfaces.  Consult the package
reference documentation for details on these advanced capabilities.
